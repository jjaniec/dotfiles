#### Setup

#set -o errexit
#set -o pipefail
#set -o nounset
#set -o xtrace

ZPLUG_DIR=/zsh/zplug
ANTIGEN_DIR=/zsh/antigen
DOTFILES_DIR=
OS=$(uname -s)

setopt autocd # If only a directory is entered, cd there
setopt no_beep
setopt hist_ignore_dups
setopt long_list_jobs
setopt mark_dirs # Add "/" if completes directory

zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'	# Case insensitive auto-completion

# Load dotfiles location

if [ -z "$DOTFILES_DIR" ];
then
	stat /dotfiles > /dev/null 2>&1;
	if [ $? -ne 0 ];
	then
		export DOTFILES_DIR=~/dotfiles;
	else
		export DOTFILES_DIR=/dotfiles;
	fi;
fi;

# Source 42 specific dotfiles
if [ $(hostname | grep -E 'e[1-9]{1,2}r[1-9]{1,2}p[1-9]{1,2}.42.fr') ] && [ -f ~/42_dotfiles ];
then
	source ~/.brewconfig
	source ~/42_dotfiles/.zshrc
fi;

# Auto-update dotfiles if new commits found

if [ -n "$DOTFILES_DIR" ];
then
	DOTFILES_BRANCH=$(git -C $DOTFILES_DIR name-rev --name-only HEAD)

	git -C $DOTFILES_DIR fetch origin $DOTFILES_BRANCH > /dev/null 2>&1
	git -C $DOTFILES_DIR diff --exit-code master...origin/$DOTFILES_BRANCH > /dev/null 2>&1
	if [ $? != 0 ];
	then
		echo "\e[32mRemote has new commits ! Updating ...\e[39m"
		git -C $DOTFILES_DIR merge origin/$DOTFILES_BRANCH
	fi;
fi;

#### Zsh plugins ####

if [ -n "$DOTFILES_DIR" ];
then
	if command -v awk > /dev/null && ! [ $(hostname | grep -E 'e[1-9]{1,2}r[1-9]{1,2}p[1-9]{1,2}.42.fr') ];

	then
		export ZPLUG_HOME=${DOTFILES_DIR}${ZPLUG_DIR}/.zplug

		if ! [ -d ${ZPLUG_HOME} ];
		then
			git clone https://github.com/zplug/zplug ${ZPLUG_HOME}
		fi;

		source ${ZPLUG_HOME}/init.zsh
		zplug 'zplug/zplug', hook-build:'zplug --self-manage'

		zplug "mafredri/zsh-async", from:github, depth:1
		zplug "sindresorhus/pure", use:pure.zsh, from:github, as:theme, depth:1

		zplug "zsh-users/zsh-autosuggestions", from:github, depth:1
		zplug "zsh-users/zsh-completions", from:github, depth:1
		zplug "zdharma/fast-syntax-highlighting", from:github, depth:1

		zplug "supercrabtree/k", from:github, depth:1
		zplug "rupa/z", from:github, use:"z.sh", depth:1
		zplug "b4b4r07/enhancd", from:github, use:"init.sh", depth:1
		zplug "raylee/tldr", from:github, as:command, use:"tldr", depth:1

		zplug "lirantal/dockly", \
			from:github, \
			as:command, \
			use:"index.js", \
			rename-to:"dockly", \
			hook-build:"npm install", \
			depth:1, \
			if:"(( $+commands[npm] ))"

		zplug "jhawthorn/fzy", \
		    from:github, \
			as:command, \
 			use:"fzy", \
			hook-build:"make", \
			depth:1

	#	if [ "${OS}" = "Linux" ];
	#	then
	#		zplug "sharkdp/bat", \
	#		    from:gh-r, \
	#			as:command, \
 	#			use:"bat-*-x86_64-unknown-linux-gnu.tar.gz", \
	#			hook-build:"make", \
	#			depth:1
	#		alias cat="bat"
	#	elif [ "${OS}" = "Darwin" ];
	#	then
	#		echo ;
	#	fi;

		if ! zplug check --verbose;
		then
		    echo;
			zplug install;
		fi;

		zplug load
	else
		if ! [ -f ${DOTFILES_DIR}${ANTIGEN_DIR}/antigen.zsh ];
		then
			git clone https://github.com/zsh-users/antigen ${DOTFILES_DIR}${ANTIGEN_DIR}
			git -C $DOTFILES_DIR$ANTIGEN_DIR checkout develop
		fi;
		git -C $DOTFILES_DIR$ANTIGEN_DIR fetch origin develop 2> /dev/null
		git -C $DOTFILES_DIR$ANTIGEN_DIR diff --exit-code origin/develop
		if [ $? != 0 ];
		then
			echo "\e[32mUpdating antigen...\e[39m"
			git -C $DOTFILES_DIR$ANTIGEN_DIR merge origin/develop
		fi;

		source $DOTFILES_DIR$ANTIGEN_DIR/antigen.zsh

		# Pure theme
		antigen bundle mafredri/zsh-async
		antigen bundle sindresorhus/pure

		# Additional features
		antigen bundle zsh-users/zsh-autosuggestions
		antigen bundle zsh-users/zsh-completions
		antigen bundle zdharma/fast-syntax-highlighting

		#antigen bundle sobolevn/wakatime-zsh-plugin

		# Additional commands
		antigen bundle eendroroy/zed-zsh

		antigen apply
	fi;
fi;

#### Git config ####

git config --global user.email "jjaniec@student.42.fr"
git config --global user.name "Joffrey Janiec"

if [ "$(uname -s)" = "Linux" ];
then
	git config --global credential.helper cache;
else
	git config --global credential.helper osxkeychain;
fi;

#### Aliases and exports ####

# Add dotfiles/bin to path
export PATH="$PATH:$DOTFILES_DIR/bin"

#export WAKATIME_HOME=$DOTFILES_DIR/zsh/.wakatime.cfg

alias glog="git log --graph --abbrev-commit --decorate --format=format:'%C(bold blue)%h%C(reset) - %C(bold green)(%ar)%C(reset) %C(white)%s%C(reset) %C(dim white)- %an%C(reset)%C(auto)%d%C(reset)'"
alias psc="ps xawf -eo pid,user,cgroup,args"
alias vcat="/bin/cat"

if [ "$(uname -s)" = "Linux" ];
then
	alias cat="$DOTFILES_DIR/bin/bat-v0.8.0-x86_64-unknown-linux-gnu"
elif [ "$(uname -s)" = "Darwin" ];
then
	alias cat="$DOTFILES_DIR/bin/bat-v0.8.0-x86_64-apple-darwin"
fi;

# Enable coloration in less
export LESS_TERMCAP_mb=$'\E[01;32m'
export LESS_TERMCAP_md=$'\E[01;32m'
export LESS_TERMCAP_me=$'\E[0m'
export LESS_TERMCAP_se=$'\E[0m'
export LESS_TERMCAP_so=$'\E[01;47;34m'
export LESS_TERMCAP_ue=$'\E[0m'
export LESS_TERMCAP_us=$'\E[01;36m'
export LESS=-r

#### Scripts ####

